<%= stylesheet_link_tag 'libraries/threejs/editor/main.css' %>
<%= stylesheet_link_tag 'libraries/threejs/editor/light.css', id: "theme" %>

<%= javascript_include_tag 'libraries/threejs/three.min.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/libs/system.min.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/controls/EditorControls.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/controls/TransformControls.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/libs/jszip.min.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/libs/inflate.min.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/loaders/AMFLoader.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/loaders/AWDLoader.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/loaders/BabylonLoader.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/loaders/ColladaLoader.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/loaders/FBXLoader.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/loaders/GLTFLoader.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/loaders/KMZLoader.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/loaders/MD2Loader.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/loaders/OBJLoader.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/loaders/MTLLoader.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/loaders/PlayCanvasLoader.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/loaders/PLYLoader.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/loaders/STLLoader.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/loaders/TGALoader.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/loaders/TDSLoader.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/loaders/UTF8Loader.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/loaders/VRMLLoader.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/loaders/VTKLoader.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/loaders/ctm/lzma.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/loaders/ctm/ctm.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/loaders/ctm/CTMLoader.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/exporters/OBJExporter.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/exporters/GLTFExporter.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/exporters/STLExporter.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/renderers/Projector.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/renderers/CanvasRenderer.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/renderers/RaytracingRenderer.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/renderers/SoftwareRenderer.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/renderers/SVGRenderer.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/codemirror/codemirror.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/codemirror/mode/javascript.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/codemirror/mode/glsl.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/esprima.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/jsonlint.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/glslprep.min.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/codemirror/addon/dialog.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/codemirror/addon/show-hint.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/codemirror/addon/tern.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/acorn/acorn.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/acorn/acorn_loose.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/acorn/walk.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/ternjs/polyfill.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/ternjs/signal.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/ternjs/tern.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/ternjs/def.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/ternjs/comment.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/ternjs/infer.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/ternjs/doc_comment.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/tern-threejs/threejs.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/signals.min.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/ui.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/ui.three.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/app.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Player.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Script.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/vr/WebVR.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Storage.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Editor.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Config.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/History.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Loader.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Menubar.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Menubar.File.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Menubar.Edit.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Menubar.Add.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Menubar.Play.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Menubar.Examples.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Menubar.Help.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Menubar.Status.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Scene.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Project.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Settings.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Properties.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Object.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Geometry.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Geometry.Geometry.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Geometry.BufferGeometry.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Geometry.Modifiers.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Geometry.BoxGeometry.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Geometry.CircleGeometry.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Geometry.CylinderGeometry.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Geometry.IcosahedronGeometry.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Geometry.PlaneGeometry.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Geometry.SphereGeometry.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Geometry.TorusGeometry.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Geometry.TorusKnotGeometry.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Geometry.TeapotBufferGeometry.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Geometry.LatheGeometry.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Material.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Animation.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.Script.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Sidebar.History.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Toolbar.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Viewport.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Viewport.Info.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/Command.js' %>
<%= javascript_include_tag 'libraries/threejs/examples/js/geometries/TeapotBufferGeometry.js' %>

<%= javascript_include_tag 'libraries/threejs/editor/js/commands/AddObjectCommand.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/commands/RemoveObjectCommand.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/commands/MoveObjectCommand.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/commands/SetPositionCommand.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/commands/SetRotationCommand.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/commands/SetScaleCommand.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/commands/SetValueCommand.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/commands/SetUuidCommand.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/commands/SetGeometryCommand.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/commands/SetGeometryValueCommand.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/commands/MultiCmdsCommand.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/commands/AddScriptCommand.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/commands/RemoveScriptCommand.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/commands/SetScriptValueCommand.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/commands/SetMaterialCommand.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/commands/SetMaterialValueCommand.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/commands/SetMaterialColorCommand.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/commands/SetMaterialMapCommand.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/commands/SetSceneCommand.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/html2canvas.js' %>
<%= javascript_include_tag 'libraries/threejs/editor/js/libs/three.html.js' %>

<%= stylesheet_link_tag 'libraries/threejs/editor/libs/codemirror/codemirror.css' %>
<%= stylesheet_link_tag 'libraries/threejs/editor/libs/codemirror/theme/monokai.css' %>
<%= stylesheet_link_tag 'libraries/threejs/editor/libs/codemirror/addon/dialog.css' %>
<%= stylesheet_link_tag 'libraries/threejs/editor/libs/codemirror/addon/show-hint.css' %>
<%= stylesheet_link_tag 'libraries/threejs/editor/libs/codemirror/addon/tern.css' %>

<script>

  window.URL = window.URL || window.webkitURL;
  window.BlobBuilder = window.BlobBuilder || window.WebKitBlobBuilder || window.MozBlobBuilder;

  const IS_MAC = navigator.platform.toUpperCase().indexOf( 'MAC' ) >= 0;

  Number.prototype.format = function (){
    return this.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,");
  };

  //

  var editor = new Editor();

  var viewport = new Viewport( editor );
  document.body.appendChild( viewport.dom );

  var script = new Script( editor );
  document.body.appendChild( script.dom );

  var player = new Player( editor );
  document.body.appendChild( player.dom );

  var toolbar = new Toolbar( editor );
  document.body.appendChild( toolbar.dom );

  var menubar = new Menubar( editor );
  document.body.appendChild( menubar.dom );

  var sidebar = new Sidebar( editor );
  document.body.appendChild( sidebar.dom );

  var modal = new UI.Modal();
  document.body.appendChild( modal.dom );

  //

  editor.setTheme( editor.config.getKey( 'theme' ) );

  editor.storage.init( function () {

    editor.storage.get( function ( state ) {

      if ( isLoadingFromHash ) return;

      if ( state !== undefined ) {

        editor.fromJSON( state );

      }

      var selected = editor.config.getKey( 'selected' );

      if ( selected !== undefined ) {

        editor.selectByUuid( selected );

      }

    } );

    //

    var timeout;

    function saveState( scene ) {

      if ( editor.config.getKey( 'autosave' ) === false ) {

        return;

      }

      clearTimeout( timeout );

      timeout = setTimeout( function () {

        editor.signals.savingStarted.dispatch();

        timeout = setTimeout( function () {

          editor.storage.set( editor.toJSON() );

          editor.signals.savingFinished.dispatch();

        }, 100 );

      }, 1000 );

    };

    var signals = editor.signals;

    signals.geometryChanged.add( saveState );
    signals.objectAdded.add( saveState );
    signals.objectChanged.add( saveState );
    signals.objectRemoved.add( saveState );
    signals.materialChanged.add( saveState );
    signals.sceneBackgroundChanged.add( saveState );
    signals.sceneFogChanged.add( saveState );
    signals.sceneGraphChanged.add( saveState );
    signals.scriptChanged.add( saveState );
    signals.historyChanged.add( saveState );

    signals.showModal.add( function ( content ) {

      modal.show( content );

    } );

  } );

  //

  document.addEventListener( 'dragover', function ( event ) {

    event.preventDefault();
    event.dataTransfer.dropEffect = 'copy';

  }, false );

  document.addEventListener( 'drop', function ( event ) {

    event.preventDefault();

    if ( event.dataTransfer.files.length > 0 ) {

      editor.loader.loadFile( event.dataTransfer.files[ 0 ] );

    }

  }, false );

  document.addEventListener( 'keydown', function ( event ) {

    switch ( event.keyCode ) {

      case 8: // backspace

        event.preventDefault(); // prevent browser back

      case 46: // delete

        var object = editor.selected;

        if ( confirm( 'Delete ' + object.name + '?' ) === false ) return;

        var parent = object.parent;
        if ( parent !== null ) editor.execute( new RemoveObjectCommand( object ) );

        break;

      case 90: // Register Ctrl-Z for Undo, Ctrl-Shift-Z for Redo

        if ( IS_MAC ? event.metaKey : event.ctrlKey ) {

          if ( event.shiftKey ) {

            editor.redo();

          } else {

            editor.undo();

          }

        }

        break;

      case 87: // Register W for translation transform mode

        editor.signals.transformModeChanged.dispatch( 'translate' );

        break;

      case 69: // Register E for rotation transform mode

        editor.signals.transformModeChanged.dispatch( 'rotate' );

        break;

      case 82: // Register R for scaling transform mode

        editor.signals.transformModeChanged.dispatch( 'scale' );

        break;

    }

  }, false );

  function onWindowResize( event ) {

    editor.signals.windowResize.dispatch();

  }

  window.addEventListener( 'resize', onWindowResize, false );

  onWindowResize();

  //

  var isLoadingFromHash = false;
  var hash = window.location.hash;

  if ( hash.substr( 1, 5 ) === 'file=' ) {

    var file = hash.substr( 6 );

    if ( confirm( 'Any unsaved data will be lost. Are you sure?' ) ) {

      var loader = new THREE.FileLoader();
      loader.crossOrigin = '';
      loader.load( file, function ( text ) {

        editor.clear();
        editor.fromJSON( JSON.parse( text ) );

      } );

      isLoadingFromHash = true;

    }

  }

  /*
  window.addEventListener( 'message', function ( event ) {

    editor.clear();
    editor.fromJSON( event.data );

  }, false );
  */

</script>